# Sudoku Strategy

> **Verified:** 2025-09-27

## Overview

| Язык | Резюме |
| --- | --- |
| **RU** | Стратегия Sudoku фиксирует цели развития solver'а и диспетчера, а также инварианты детерминизма. |
| **EN** | The Sudoku strategy captures the solver roadmap, dispatcher determinism invariants, and supporting measurement plans. |

Документ описывает ключевые цели владельца продукта и базовые ограничения детерминизма, которыми руководствуется команда при развитии генератора и решателя Sudoku.

## Strategic Objectives

1. **Полный перенос логики на модульный solver (novus primary).** Первая фаза —
   dev-профиль с тенью: `config.toml` фиксирует `impl=novus`, `state=shadow`,
   sampling=0.25; `shadow_mode` управляется фича-флагом. Пайплайн собирает
   отчёты determinism/parity/shadow перед переключением primary.
2. **Многопоточность для solver'а и диспетчера.** При одном потоке — последовательный проход; при N > 1 — очереди и параллелизм допустимых приёмов.
3. **Тестирование и метрики в два слоя.**
   - Продуктовые: ритм/кульминации, равномерность сложности, однозначность шагов, геометрическая красота.
   - Техконтур: сид-дисциплина, воспроизводимость, NFR-профиль и данные для настройки параллелизма.
4. **Один модифицированный «алгоритм-изюминка» для эстетики на medium.**
5. **Перенос на 16×16** с максимальным переиспользованием модулей и диспетчера.

### Инварианты детерминизма диспетчера

- Двухфазная схема: вычисление предложений (compute proposals) выполняется параллельно, фиксация (commit) строго по канону.
- Канон коммита: `ELIM` < `PLACE` → cell asc (0..80) → digit asc (1..9).
- Режим в один поток служит эталоном; при любом N > 1 результат идентичен по CompleteGrid, SolveTrace и артефактам (JCS). Логи сравнимы после нормализации.
- Запрет параллелить шаги с зависимостями; спекулятивные результаты перепроверяются перед коммитом.
- Источники времени/рандома/локали не влияют на логику; такие поля исключаются из сравнения.

### 2025-09-27 — Dev shadow bring-up

- Novus подключён в профиле `dev` через shadow-режим с делегированием на legacy.
- Shadow сравнения ведут baseline `legacy` против `novus`, логи сохраняются в
  `logs/shadow/YYYYMMDD/` и проходят каноническую нормализацию.
- CLI `python -m tools.cli.orchestrate run-one --profile dev --shadow-enabled`
  служит эталонным способом прогнать shadow на выборке сидов.
- Целевые гейты: determinism_50x3, parity_500_wilson и shadow_overhead_guard.
- **ALG acceptance (2025-09-27):** запуск `determinism_50x3` (50×3, dev,
  seeds из `tools/ci/seeds_YYYYMMDD.txt`) без расхождений; `parity_500_wilson`
  выдаёт нижнюю границу ≥ 0.995, критических mismatch=0; `shadow_overhead_guard`
  фиксирует `p95(Δ) ≤ 50 ms` и `p95_ratio ≤ 1.05`. Отчёты записываются в
  `reports/*/report.json` и публикуются в `REPORT.md`.

## Horizons

- **3 месяца:** production-readiness для sudoku-9×9: стабильные CI-гейты, закрытые технические долги и готовность переключить профиль `prod` на novus.
- **12 месяцев:** расширение кросс-пазлового портфеля (16×16, killer, вариации) с едиными контрактами и повторно используемыми стадиями.

## Goal Stack

| Level | Dev profile | Prod profile |
| --- | --- | --- |
| Guardrail (текущая итерация) | p95 ≤ 400 ms | p95 ≤ 300 ms |
| SLO (1–2 итерации) | p95 ≤ 250 ms | p95 ≤ 150 ms |
| North-Star (12 мес) | p95 ≤ 150 ms | p95 ≤ 75 ms |

## Guiding Principles

1. **Детерминизм как инвариант.** Один сид ⇒ один набор артефактов, никакой недетерминированности в портах.
2. **JCS везде.** Отчёты, артефакты и логи канонизируются по RFC 8785, чтобы гейты могли сравнивать побайтно.
3. **Без сетевых зависимостей.** CI и офлайн-скрипты не требуют сети; данные хранятся в репозитории или в артефакт сторе.
4. **Паритет перед переключением.** Переключение `prod` допускается только при выполненных гейтах determinism/parity/NFR/shadow.
5. **Документированность.** Каждое изменение стратегии сопровождается записью в CHANGELOG и ссылкой на проверку.

## Risks & Assumptions

- **Аппаратный дрейф.** Латентность и RSS чувствительны к окружению. Контролируем через фиксированные профили и baseline-отчёты.
- **Недостаточная выборка.** Гейты работают на 500–1000 сидов; при расширении нужно масштабировать корпуса и удерживать время выполнения ≤ 15 минут.
- **Shadow overhead.** Увеличение `sample_rate` без контроля overhead бьёт по latency. Используем `shadow_overhead_guard` для авто-регулировки.
- **Баланс сложностей.** Acceptance-корпус балансирован 4:4:2; изменения только через v2 и ADR.

## Compatibility

- Форматы Envelope и ArtifactRef стабильны; несовместимые изменения требуют ADR и записи в `MIGRATIONS.md`.
- Отчёты `tools/ci` канонизированы и сравниваются побайтно; timestamp/uuid внутрь отчёта не пишем.
- Acceptance-корпус `acceptance_corpus_9x9_v1.json` immutable; любые обновления — через новую версию и совместное решение ARC + ALG + INT.
