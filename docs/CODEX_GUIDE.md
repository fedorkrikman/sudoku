# CODEX_GUIDE

## 1. Назначение и область действия
Документ адресован Codex, работающему в IDE над изменениями в этом репозитории. Руководство описывает ожидания к структуре PR, проверкам и артефактам. В объём не входят сетевые вызовы или добавление URL, самостоятельные переименования без соответствующего ADR и задачи вне этого репозитория.

## 2. Инварианты архитектуры (не нарушать)
- Артефакты создаются только через Artifact Store, идентификатор имеет вид `sha256-…`, JSON канонизируется.
- Все стыки проходят через Единый Валидационный Центр: `validate`/`assert_valid` вызываются на входе и выходе стадий.
- Порты стадий детерминированы, не имеют сайд-эффектов и принимают/возвращают только артефакты по утверждённым схемам.
- `ExportBundle` содержит только ссылки (`*_ref`), рендер читает данные исключительно через стор.
- Имена файлов Windows-safe: символ `:` недопустим.
- Никаких разнородных правок в одном PR: один смысл — один PR.

## 3. Контракты и версии
- Схемы расположены в `PuzzleContracts/schemas/**`, каждая имеет `$id = urn:puzzle:schemas/<type>:<version>`.
- Envelope обязателен: все артефакты несут поля `artifact_id`, `artifact_type`, `artifact_version`, `created_at` и `payload`.
- Любая несовместимая правка требует ADR и миграции; базовая линия — версия v1.x.

## 4. Профили валидации
- Профили: `dev` (по умолчанию), `ci` (интерпретирует WARN как ERROR), `prod` (облегчённые второстепенные проверки).
- Переключение выполняется через переменную окружения `PUZZLE_VALIDATION_PROFILE` или параметр оркестратора.

## 5. Оркестратор и многозадачность — границы
- Оркестратор не содержит доменной логики; он управляет типами артефактов и стадиями.
- Многозадачность — способ исполнения. Вход задачи имеет форму `{stage, input_artifact_id, seed, options}`.

## 6. Правила ветвления/коммитов/PR
- Ветки называются `codex/<feature-kebab>`.
- Коммиты — в императивном наклонении, небольшими партиями и без смешения смыслов.
- Каждый PR включает описание цели, ссылки на разделы этого руководства и `docs/GOALS_ROADMAP.md`, а также чек-лист DoD (см. шаблон PR).

## 7. [HANDOFF] блок в описаниях PR
Формируйте [HANDOFF] из 3–6 пунктов с конкретными шагами для Codex: создание файлов, добавление портов, обновление README/ADR и т. п. Без кода и Git-деталей.

## 8. Запрещено
- Менять схемы без обновления `catalog.json` и соответствующего ADR.
- Встраивать логику валидации внутрь стадий: все проверки проходят через ЕВЦ.
- Добавлять сетевые зависимости или URL.

## 9. Мини-чек-лист для каждого PR
- Валидация артефактов проходит (`scripts/check_contracts.py`).
- Детерминизм проверен (`scripts/smoke_determinism.py`).
- README и ADR обновлены при изменении инвариантов или процессов.
- Нет смешения несвязанных изменений.
