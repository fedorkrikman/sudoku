# ADR-0002: Единый Валидационный Центр

## Контекст

Проверки артефактов были раскиданы по стадиям пайплайна, имели разную строгость и
не всегда совпадали со схемами PuzzleContracts. Скрипты офлайн-проверок
использовали отдельные реализации и дублировали логику оркестратора. Для
перехода к многопоточному пайплайну и дальнейшему развитию контрактов нужна одна
точка входа для всех проверок и управляемые профили строгости.

## Решение

- В `src/contracts/` создан пакет Validation Center: загрузчик схем
  (`loader.py`), таксономия ошибок (`errors.py`), профили (`profiles.py`),
  реестр правил (`rulebook.py`) и фасад (`validator.py`).
- `validator.validate/assert_valid` выполняют цепочку проверок: envelope,
  офлайн-валидацию по JSON-Schema, доменные инварианты и кросс-ссылки между
  артефактами.
- Все стадии оркестратора вызывают `validator.assert_valid(..., store=artifact_store)`
  перед записью артефакта, экспорт дополнительно проверяет пакет через
  `check_refs`.
- В `rulebook` зарегистрированы правила v1 для Spec, CompleteGrid, Verdict и
  ExportBundle: размеры и алфавит, консистентность решётки, XOR ссылок verdict,
  формат экспортного пакета и согласованность `spec_ref`.
- Профили `dev`, `ci`, `prod` настраивают включение правил и обработку WARN.
  В `ci` предупреждения валят пайплайн, в `prod` второстепенные проверки (например
  `verdict.cutoff.invalid`) понижаются до WARN, но кросс-ссылки остаются строгими.
- `scripts/check_contracts.py` и `scripts/smoke_determinism.py` переведены на
  новый фасад и используют единое хранилище фикстур/артефактов.

## Последствия

- Валидация собрана в одном месте, профили переключаются через параметр или
  `PUZZLE_VALIDATION_PROFILE`, а WARN в CI становятся ошибками.
- Оркестратор и скрипты офлайн-проверок используют один и тот же API, дубликаты
  проверок из стадий удалены.
- Реестр правил расширяется централизованно, что упрощает добавление новых
  артефактов и ужесточение прод-проверок.
